generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum PermissionEffect {
  ALLOW
  DENY
}

enum NewsStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum InboundRequestType {
  CONTACT
  DEMO
}

enum InboundRequestStatus {
  NEW
  IN_PROGRESS
  DONE
  SPAM
}

model AdminRole {
  id          Int              @id @default(autoincrement())
  key         String           @unique // ROOT, EDITOR, SUPPORT, VIEWER
  label       String
  users       AdminUser[]
  permissions RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model AdminUser {
  id           Int     @id @default(autoincrement())
  username     String  @unique
  passwordHash String
  active       Boolean @default(true)

  roleId Int
  role   AdminRole @relation(fields: [roleId], references: [id])

  overrides   UserPermissionOverride[]
  lastLoginAt DateTime?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  newsCreated NewsPost[]               @relation("NewsCreatedBy")
  newsUpdated NewsPost[]               @relation("NewsUpdatedBy")
}

model Permission {
  id          Int    @id @default(autoincrement())
  key         String @unique
  label       String
  description String @default("")
  category    String @default("General")
  sort        Int    @default(100)

  roles     RolePermission[]
  overrides UserPermissionOverride[]
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
}

model RolePermission {
  id           Int     @id @default(autoincrement())
  roleId       Int
  permissionId Int
  allowed      Boolean @default(false)

  role       AdminRole  @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserPermissionOverride {
  id           Int              @id @default(autoincrement())
  userId       Int
  permissionId Int
  effect       PermissionEffect

  user       AdminUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model NewsPost {
  id      Int    @id @default(autoincrement())
  lang    String @default("de") // de | en
  title   String
  slug    String @unique
  excerpt String? @db.Text
  content String @db.LongText

  status      NewsStatus @default(DRAFT)
  publishedAt DateTime?
  scheduledAt DateTime?

  createdById Int?
  createdBy   AdminUser? @relation("NewsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  updatedById Int?
  updatedBy   AdminUser? @relation("NewsUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, publishedAt])
  @@index([lang, status])
}

model InboundRequest {
  id          String              @id @default(cuid())
  type        InboundRequestType
  status      InboundRequestStatus @default(NEW)

  lang        String

  name        String
  email       String
  company     String?
  phone       String?
  message     String

  // Spam/Rate-Limit (minimal, aber effektiv)
  ipHash      String?
  userAgent   String?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  handledAt   DateTime?
  adminNotes  String?

  @@index([type, status, createdAt])
  @@index([email, createdAt])
  @@index([ipHash, createdAt])
}
